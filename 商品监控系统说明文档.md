# 商品监控与推送系统说明文档

> 版本: 3.0  
> 更新日期: 2025-11-26

---

## 一、系统概述

本系统是一个自动化商品监控工具，用于实时监控指定网站的商品变化，筛选符合条件的商品，并通过企业微信机器人推送通知。

### 核心功能

- 🔍 **实时监控**: 每5秒检查一次商品列表变化
- 🎯 **智能筛选**: 多维度过滤（品牌、尺码、价格、订单数）
- 🔄 **冷却机制**: 防止同一尺码重复推送（3.5天冷却期）
- 📱 **分群推送**: 根据尺码数量分配到不同企业微信群
- ⚡ **并发处理**: 8线程并发获取商品详情

---

## 二、文件结构

```
项目目录/
├── main.py                    # 程序入口
├── product_monitor.py         # 核心监控模块
├── detail_processor.py        # 商品详情处理模块
├── wechat_bot.py             # 企业微信推送模块
├── base_login.py             # 登录认证模块
├── data_initializer.py       # 数据初始化模块
├── reset_counters.py         # 计数器重置工具
├── initial_products_data.json # 商品数据存储
├── cooldown_state.json       # 冷却状态记录
├── daily_counter.json        # 每日计数器
└── products_output.txt       # 推送日志
```

---

## 三、运行方式

### 首次运行

```bash
python main.py
```

程序会自动：
1. 检测初始数据文件是否存在
2. 不存在则初始化数据（获取所有商品）
3. 开始监控商品变化

### 重置计数器

```bash
# 重置所有群组的计数器
python reset_counters.py

# 重置指定群组的计数器
python reset_counters.py 1  # 群组1
python reset_counters.py 2  # 群组2
python reset_counters.py 3  # 群组3
```

---

## 四、筛选规则

### 1. 品牌过滤

以下品牌的商品会被排除：

```
Under Armour, HOKA, Saucony, Salomon, PUMA, Li-Ning, New Balance, UGG,
ASICS, Reebok, ANTA, 361°, FILA, Pop Mart, Crocs, On昂跑, Birkenstock,
Arc'teryx始祖鸟, MLB, Onitsuka Tiger, Dr.Martens, ECCO, Timberland,
Michael Kors, 特步, 迪桑特, Mizuno, 斯凯奇, YONEX, Skechers, Vans,
Converse, Louis Vuitton, 北面, 迪卡侬
```

### 2. 尺码过滤

只保留以下尺码：
```
35.5, 36, 36.5, 37, 37.5, 38, 38.5, 39, 39.5,
40, 40.5, 41, 41.5, 42, 42.5, 43, 43.5, 44, 44.5, 45
```

### 3. 价格过滤

- 最低价格: **270元**
- 最高价格: **1800元**
- 特殊情况: **价格为0** 或 **未出价** 也视为有效

### 4. 订单数过滤

只推送 **订单数 > 0** 的尺码

---

## 五、推送触发条件

系统只在以下情况触发推送：

| 条件 | 说明 |
|------|------|
| 新增商品 | 首次出现的商品，且有未冷却的符合条件的尺码 |
| 订单变化 | 某尺码的订单数从 **0 变为 >0**，且该尺码未冷却 |

**不会触发推送的情况：**
- 订单数 1→2, 2→3 等（非0→正数的变化）
- 尺码在冷却期内（3.5天）
- 商品被品牌过滤排除

---

## 六、冷却机制

### 冷却规则

- **冷却对象**: 货号 + 尺码（例如 `HQ2011-100_43`）
- **冷却时间**: 3.5天（84小时）
- **触发时机**: 推送成功后

### 冷却效果

冷却期内，该尺码：
- 不会触发新的推送
- 显示剩余冷却时间（控制台输出）

---

## 七、群组分配

根据商品显示的尺码数量分配到不同群组：

| 群组 | 尺码数量 | 说明 |
|------|----------|------|
| 群组1 | ≤2个 | 少量尺码 |
| 群组2 | 3-5个 | 中等数量 |
| 群组3 | ≥6个 | 大量尺码 |

每个群组有独立的编号计数器（NO.1, NO.2, ...）

---

## 八、输出格式说明

```
【NO.123】(群组2)

🆕【40】520.0(0→1)  ⏱2025-11-26 22:44:32
https://www.goofish.com/search?q=HQ2011-100+40

📌【41】530.0(1→2)  ⏱2025-11-26 22:40:00
https://www.goofish.com/search?q=HQ2011-100+41

【42】580.0(旧价格)(2→2)  ⏱2025-11-26 22:35:00
https://www.goofish.com/search?q=HQ2011-100+42

商品标题HQ2011-100
https://www.goofish.com/search?q=HQ2011-100
价格区间：【150-500】
尺码符合要求范围【40、41】
```

### 标记说明

| 标记 | 含义 |
|------|------|
| 🆕 | 订单数从0变为>0（新增订单） |
| 📌 | 订单数已>0（有订单但非新增） |
| 无标记 | 不在筛选范围内（价格超范围或订单数为0） |
| (旧价格) | 当前价格为0或未知，使用上次采集的价格 |

### 格式解释

```
【尺码】价格(旧订单数→新订单数)  ⏱最新订单时间
```

---

## 九、价格区间计算

价格区间基于符合条件的尺码价格计算：

- **最低价格** = 最低价格 × 0.3（但不低于150）
- **最高价格** = 最高价格 - 30

---

## 十、配置参数

### 监控参数 (product_monitor.py)

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `COOLDOWN_DAYS` | 3.5 | 冷却天数 |
| `max_workers` | 8 | 并发线程数 |

### 筛选参数 (detail_processor.py)

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `PRICE_MIN` | 270.0 | 最低价格 |
| `PRICE_MAX` | 1800.0 | 最高价格 |
| `ALLOWED_SIZES` | 35.5-45 | 允许的尺码 |

### 运行参数 (main.py)

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `check_interval` | 5 | 监控间隔（秒） |

---

## 十一、企业微信机器人配置

### 配置位置

`wechat_bot.py` 文件中的以下变量：

```python
# 群组1：≤2个尺码
self.webhook_urls_group_1 = [
    'https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxx'
]

# 群组2：3≤5个尺码
self.webhook_urls_group_2 = [
    'https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxx'
]

# 群组3：≥6个尺码
self.webhook_urls_group_3 = [
    'https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxx'
]
```

### 添加多个机器人

每个群组支持多个机器人（轮询发送）：

```python
self.webhook_urls_group_1 = [
    'https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=机器人1',
    'https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=机器人2',
    'https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=机器人3',
]
```

---

## 十二、数据文件说明

### initial_products_data.json

存储所有商品数据和历史快照，包含：
- 商品基本信息（ID、标题、货号、图片等）
- 尺码价格快照
- 历史订单数据

### cooldown_state.json

存储尺码冷却状态：
```json
{
  "HQ2011-100_43": 1732636872.123,
  "DV5456-002_40": 1732636800.456
}
```

### daily_counter.json

存储每日计数器：
```json
{
  "date": "2025-11-26",
  "counter_group_1": 123,
  "counter_group_2": 45,
  "counter_group_3": 67
}
```

---

## 十三、常见问题

### Q1: 为什么商品没有被推送？

可能原因：
1. 尺码在冷却期内（3.5天）
2. 订单数没有从0变为>0
3. 品牌在排除列表中
4. 价格不在270-1800范围内
5. 尺码不在35.5-45范围内

### Q2: 如何清除冷却状态？

删除 `cooldown_state.json` 文件，或手动编辑删除特定尺码的冷却记录。

### Q3: 如何重置编号？

```bash
python reset_counters.py
```

### Q4: 推送失败怎么办？

系统会自动回滚计数器，下次检测到变化时会重新推送。

---

## 十四、系统流程图

```
程序启动
    │
    ▼
检查初始数据 ──不存在──→ 初始化数据
    │
    │ 存在
    ▼
登录系统（验证码识别）
    │
    ▼
┌─────────────────────────┐
│      主监控循环          │ ←──────────────────┐
│                         │                    │
│  1. 获取商品列表（分页）  │                    │
│  2. 检测变化（新增/更新） │                    │
│  3. 并发获取详情         │                    │
│  4. 筛选符合条件的尺码   │                    │
│  5. 判断是否推送         │                    │
│  6. 推送到企业微信       │                    │
│  7. 更新历史数据         │                    │
│                         │                    │
└─────────────────────────┘                    │
    │                                          │
    ▼                                          │
等待5秒 ──────────────────────────────────────┘
```

---

